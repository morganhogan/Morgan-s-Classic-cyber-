<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CLASSIC CYBER PRODUCTS</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: deepskyblue; }
  header { 
    display: flex; 
    justify-content: space-between; /* Ensures space between title, search, and cart */
    align-items: center; 
    background: yellow; 
    padding: 10px 10px; 
    position: sticky; 
    top: 0; 
    z-index: 100; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
  }
  #cart-header { position: relative; cursor: pointer; font-weight: bold; }
  #cart-dropdown { 
    display: none; 
    position: absolute; 
    right: 0; 
    top: 40px; 
    background: lightyellow; 
    border: 1px solid #ccc; 
    width: 350px; 
    z-index: 100; 
    max-height: 400px; 
    overflow-y: auto; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    padding: 10px; 
  }


  #cart-dropdown.show { display: block; }
  #items { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
  .item { border: 1px solid #ccc; padding: 5px; text-align: center; width: 150px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; background: white; border-radius: 7px; }
  .item:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
  .item img { width: 150px; height: 120px; object-fit: cover; margin-bottom: 2px; border-radius: 2px; }
  .cart-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .cart-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; margin-right: 10px; }
  .cart-item-details { flex: 1; display: flex; justify-content: space-between; align-items: center; }
  .cart-item input { width: 50px; margin-left: 5px; }
  /* Note: The CSS below causes inputs to be half-width based on the file provided */
  input[type="text"], input[type="email"], textarea { width: 50%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; } 
  
  /* ADDED SPECIFIC STYLE FOR THE MOVED SEARCH BAR */
  #search {
    width: 250px; /* Set a specific width for the search bar */
    padding: 5px 10px; /* Adjusted padding for better look */
    border-radius: 5px; 
    border: 1px solid #ccc;
    box-sizing: border-box; 
    /* Overrides the 50% width rule for checkout fields */
    width: auto; 
  }
  
  button { cursor: pointer; padding: 5px 10px; border: none; border-radius: 3px; background: #28a745; color: #fff; transition: background 0.2s; }
  button:hover { background: #218838; }
  
  /* --- Checkout "New Page" Styles --- */
  /* Hide the product and search view */
  #product-view.hidden { display: none; }
  
  /* Make checkout-container visible and fill the main area */
  #checkout-container { 
      display: none; 
      margin-top: 20px; 
      background: #fff; 
      padding: 20px; 
      border-radius: 5px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
  }
  
  /* Style for M-PESA Box */
  .mpesa-box {
      border: 2px solid #2ecc71; /* Green border for M-Pesa */
      background: #e6ffe6; /* Light green background */
      padding: 15px;
      margin-top: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      text-align: center;
      font-size: 1.1em;
      line-height: 1.6;
  }
  .mpesa-box strong {
      color: #27ae60;
      font-size: 1.3em;
  }
  .mpesa-textarea {
      resize: vertical;
      min-height: 80px;
      margin-bottom: 10px;
  }

  /* Style for cart close button */
  #cart-close-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 20px;
      cursor: pointer;
      color: darkred;
      line-height: 1;
  }
  
  /* Style for Checkout Back button */
  #back-to-products {
      background: green;
      margin-bottom: 15px;
      padding: 10px 15px;
  }
  #back-to-products:hover {
      background: #5a6268;
  }
  
  .hidden { display: none; }
</style>
</head>
<body>

<header>
  <h1 style="color:red;">CLASSIC CYBER PRODUCTS</h1>
  <input type="text" id="search" placeholder="Search items..." oninput="searchItems()">
  <div id="cart-header" onclick="toggleCart()">
    üõí Cart (<span id="cart-count">0</span>)
    <div id="cart-dropdown">
        <span id="cart-close-icon" onclick="event.stopPropagation(); toggleCart();">‚ùå</span>
    </div>
  </div>
</header>

<div id="product-view">
    <div id="items"></div>
</div>

<div id="checkout-container">
  <button id="back-to-products" onclick="hideCheckoutForm()">‚Üê Back to Products</button>
  <h2>Customer Information</h2>
  
  <div id="step-1-order">
    <p style="color: blue;">Step 1: Fill in your details and place your order.</p>
    <form id="orderForm" action="https://formspree.io/f/xgvrwabn" method="POST">
      <input type="text" id="customer-name" name="Name" placeholder="Full Name" required>
      <input type="text" id="customer-address" name="Address" placeholder="Address" required>
      <input type="text" id="customer-phone" name="Phone_Number" placeholder="Phone Number" required>
      <input type="email" id="customer-email" name="Email" placeholder="Email" required>
      
      <textarea class="hidden" id="order-summary-field" name="Order_Details"></textarea>

      <p class="hidden" id="errorMessage" style="color: red; font-weight: bold;">‚ùå Please fix the error(s) above and try again.</p>
    </form>
    
    <button type="submit" onclick="return placeOrder(event)">Place Order</button>
  </div>
  
  <div id="step-2-mpesa" class="hidden">
    <p style="color: blue; border-top: 1px solid #ccc; padding-top: 10px;">Step 2: Pay via M-Pesa, then confirm.</p>
      
    <div class="mpesa-box">
        <p><strong>To Complete Your Order (M-Pesa):</strong></p>
        <p>Go to **Lipa na M-Pesa -> Buy Goods and Services**</p>
        <p>Enter TILL NO: <strong>6705061 (MORGAN)</strong></p>
        <p style="margin-top: 10px;">Enter the exact Total Amount: <strong id="mpesa-total-display">KES 0</strong></p>
    </div>
      
    <form id="mpesaForm" action="https://formspree.io/f/xgvrwabn" method="POST">
        <input type="hidden" id="mpesa-hidden-name" name="Customer Name">
        <input type="hidden" id="mpesa-hidden-phone" name="Customer Phone">
        <input type="hidden" id="mpesa-hidden-order-summary" name="Original Order Summary">

        <label for="mpesa-confirmation-message">Paste M-Pesa Confirmation SMS:</label>
        <textarea class="mpesa-textarea" id="mpesa-confirmation-message" name="MPESA Confirmation Message" placeholder="Paste the confirmation SMS (e.g., QAB2C12345 confirmed KES 1500 to 6705061) here..." required></textarea>
        
        <p class="hidden" id="mpesaErrorMessage" style="color: red; font-weight: bold;">‚ùå Please paste the M-Pesa message before confirming.</p>

        <button type="submit" onclick="return confirmMpesaPayment(event)" style="background: darkred;">Confirm Payment</button>
    </form>
    
    <p class="hidden" id="mpesaSuccessMessage" style="color: green; font-weight: bold; margin-top: 15px; text-align: center;">‚úÖ Payment confirmed! Your order will be processed and delivered shortly.</p>

  </div>
  
</div>

<script>
let items = [
  {name: "Earpods", price: 450, img: "Earpods.jfif"},
  {name: "Screen protectors", price: 100, img: "Screen protectors.jpg"},
  {name: "Oraimo USB cable", price: 250, img: "Oraimo USB cable.webp"},
  {name: "Headphones", price: 800, img: "Headphones.jfif"},
  {name: "Re-writable cd disks", price: 250, img: "Re-writable cd disks.jfif"},
  {name: "Earphones", price: 150, img: "Earphones.jfif"},
  {name: "Extensions", price: 500, img: "Extensions.jpg"},
  {name: "Oraimo Earphones", price: 200, img: "Oraimo Earphones.jfif"},
  {name: "Memory Card Readers", price: 50, img: "Memory Card Reader.jpg"},
  {name: "Oraimo chargers", price: 450, img: "Oraimo chargers.jfif"},
  {name: "HDMI Cable", price: 200, img: "HDMI Cable.jfif"},
  {name: "JBL Headphones", price: 1200, img: "JBL Headphones.webp"},
  {name: "Writable cd disks", price: 30, img: "Writable cd disks.jfif"},
  {name: "Bulbs", price: 100, img: "Bulbs.jfif"},
  {name: "Amaya PowerBanks", price: 1150, img: "Amaya Powerbanks.webp"}
 
];

let cart = [];
let currentOrderDetails = {};

// Display products
function displayItems(list) {
  const itemsDiv = document.getElementById('items');
  itemsDiv.innerHTML = '';
  list.forEach((item) => { 
    itemsDiv.innerHTML += `
      <div class="item" onclick="addToCart('${item.name.replace(/'/g, "\\'")}')">
        <img src="${item.img}" alt="${item.name}">
        <div><strong>${item.name}</strong></div>
        <div>KES ${item.price}</div>
      </div>
    `;
  });
}

// Add product to cart
function addToCart(itemName) { 
  const itemToAdd = items.find(i => i.name === itemName);
  if (!itemToAdd) return; 
  
  const existing = cart.find(i => i.name === itemName);
  if (existing) {
    existing.qty += 1;
  } else {
    cart.push({...itemToAdd, qty: 1}); 
  }
  displayCart();
  // The cart no longer opens automatically when an item is added.
}

// Display cart
function displayCart() {
  const cartDropdown = document.getElementById('cart-dropdown');
  // Preserve the close icon when re-rendering
  cartDropdown.innerHTML = '<span id="cart-close-icon" onclick="event.stopPropagation(); toggleCart();">‚ùå</span>'; 
  
  let total = 0;
  let count = 0;
  
  if (cart.length === 0) {
    cartDropdown.innerHTML += "<p style='padding: 10px; margin-top: 20px;'>Cart is empty.</p>";
  } else {
    const itemsList = document.createElement('div');
    itemsList.style.marginTop = '20px'; // Offset for the close icon

    cart.forEach((item, i) => {
      total += item.price * item.qty;
      count += item.qty;
      itemsList.innerHTML += `
        <div class="cart-item">
          <img src="${item.img}" alt="${item.name}">
          <div class="cart-item-details">
            <span>${item.name} - KES ${item.price}</span>
            <div>
              Qty: <input type="number" value="${item.qty}" min="1" onchange="updateQty(${i}, this.value)">
              <button onclick="removeItem(${i})" style="background:darkred; padding: 3px 6px;">Remove</button>
            </div>
          </div>
        </div>
      `;
    });
    
    cartDropdown.appendChild(itemsList);
    
    cartDropdown.innerHTML += `<p style='border-top: 1px solid #ccc; padding-top: 5px; margin-top: 10px;'><strong>Total: KES <span id="total">${total}</span></strong></p>
      <button onclick="showCheckoutForm()" style="width:100%;">Checkout</button>`;
  }
  
  document.getElementById('cart-count').innerText = count;
}

// Update quantity (explicitly keeps the cart open)
function updateQty(index, qty) {
  const numberQty = parseInt(qty);
  if (isNaN(numberQty) || numberQty <= 0) {
    // If quantity is invalid or zero, remove the item
    cart.splice(index, 1);
  } else {
    cart[index].qty = numberQty;
  }
  displayCart();
  // Keep cart open after updating/removing an item (Requirement)
  document.getElementById('cart-dropdown').classList.add('show');
}

// Remove item (explicitly keeps the cart open)
function removeItem(index) {
  cart.splice(index, 1);
  displayCart();
  // Keep cart open after removing an item (Requirement)
  document.getElementById('cart-dropdown').classList.add('show');
}

// Search products
function searchItems() {
  const term = document.getElementById('search').value.toLowerCase();
  const filtered = items.filter(item => item.name.toLowerCase().includes(term));
  displayItems(filtered);
}

// Toggle cart dropdown
function toggleCart() {
  document.getElementById('cart-dropdown').classList.toggle('show');
}

// Show checkout form (as a new page view)
function showCheckoutForm() {
  if(cart.length === 0){
    alert("Cart is empty! Please add products before checking out.");
    return;
  }
  
  // Requirement 3: Simulate "new page" by hiding product view and showing checkout view
  document.getElementById('product-view').classList.add('hidden');
  document.getElementById('checkout-container').style.display = 'block';

  // Reset view to Step 1
  document.getElementById('step-1-order').classList.remove('hidden');
  document.getElementById('step-2-mpesa').classList.add('hidden');
  document.getElementById('mpesaSuccessMessage').classList.add('hidden');
  document.getElementById('cart-dropdown').classList.remove('show'); // Always close cart on checkout
  
  document.getElementById('errorMessage').classList.add('hidden');
  document.getElementById('mpesaErrorMessage').classList.add('hidden');
  
  // Update the displayed total amount
  const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
  document.getElementById('mpesa-total-display').innerText = `KES ${total}`;
}

// Function to hide the checkout form and return to product view
function hideCheckoutForm() {
    document.getElementById('product-view').classList.remove('hidden');
    document.getElementById('checkout-container').style.display = 'none';
    
    // Ensure Step 2 is hidden when returning to products
    document.getElementById('step-1-order').classList.remove('hidden');
    document.getElementById('step-2-mpesa').classList.add('hidden');
}


// Step 1: Place Order (Submits order details)
async function placeOrder(e) {
  e.preventDefault(); 

  const form = document.getElementById('orderForm');
  const errorMessage = document.getElementById('errorMessage');

  // --- 1. VALIDATION CHECK ---
  const name = document.getElementById('customer-name').value.trim();
  const address = document.getElementById('customer-address').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  
  errorMessage.classList.add('hidden');
  
  // Note: Cart check is implicitly handled before calling this function in showCheckoutForm, but good to keep a final check.
  if (cart.length === 0) {
    alert("Cart is empty! Please return to products and add items.");
    hideCheckoutForm(); // Send user back
    return false;
  }
  
  if (!name || !address || !phone || !email) {
    alert("Please fill in all required customer details (Name, Address, Phone, Email) to place your order.");
    errorMessage.classList.remove('hidden');
    return false;
  }
  // ------------------------------------

  // 2. Build Order Summary
  let orderSummary = "NEW CUSTOMER ORDER:\n";
  orderSummary += "--------------------------------------\n";

  cart.forEach(item => {
    orderSummary += `${item.name} x${item.qty} (KES ${item.price * item.qty})\n`;
  });

  const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
  orderSummary += `--------------------------------------\n`;
  orderSummary += `TOTAL: KES ${total}\n`;
  orderSummary += "--------------------------------------";

  // 3. Populate global object and hidden fields for Step 2
  currentOrderDetails = {
      name: name,
      phone: phone,
      summary: orderSummary,
      total: total
  };
  document.getElementById('mpesa-hidden-name').value = name;
  document.getElementById('mpesa-hidden-phone').value = phone;
  document.getElementById('mpesa-hidden-order-summary').value = orderSummary;
  
  // 4. Insert Summary into Step 1 hidden field and submit to Formspree (Email 1)
  document.getElementById('order-summary-field').value = orderSummary;
  
  const formData = new FormData(form);
  const response = await fetch(form.action, {
    method: form.method,
    body: formData,
    headers: { Accept: "application/json" }
  });
  
  // 5. Handle response
  if (response.ok) {
    // SUCCESS: Hide step 1, show step 2
    document.getElementById('step-1-order').classList.add('hidden');
    document.getElementById('step-2-mpesa').classList.remove('hidden');
    
    // Ensure Mpesa form is visible for the customer
    document.getElementById('mpesaForm').classList.remove('hidden');

    // ACTION: Clear Step 1 customer input fields
    form.reset(); 
    
    // Clear cart since order is placed
    cart = []; 
    displayCart(); // Update cart count in header
    
    // Reset M-Pesa confirmation field for a new entry
    document.getElementById('mpesa-confirmation-message').value = '';
    
  } else {
    // FAILURE
    errorMessage.classList.remove('hidden');
    alert("There was an issue submitting your order. Please try again.");
  }
  
  return false;
}

// Step 2: Confirm M-Pesa Payment (Submits confirmation message)
async function confirmMpesaPayment(e) {
    e.preventDefault();

    const form = document.getElementById('mpesaForm');
    const mpesaMessage = document.getElementById('mpesa-confirmation-message').value.trim();
    const errorMessage = document.getElementById('mpesaErrorMessage');
    
    errorMessage.classList.add('hidden');

    if (!mpesaMessage) {
        alert("Please paste your M-Pesa confirmation message to confirm payment.");
        errorMessage.classList.remove('hidden');
        return false;
    }
    
    // Submit to Formspree (Email 2)
    const formData = new FormData(form);
    const response = await fetch(form.action, {
        method: form.method,
        body: formData,
        headers: { Accept: "application/json" }
    });

    if (response.ok) {
        // SUCCESS: Show final success message and hide the confirmation form
        const successMessage = document.getElementById('mpesaSuccessMessage');
        const mpesaForm = document.getElementById('mpesaForm');

        successMessage.classList.remove('hidden');
        mpesaForm.classList.add('hidden'); // Hide the confirmation message form
        
        // ACTION: Clear M-Pesa input fields
        form.reset();
        
        // Wait, then reset to Step 1 for a new order and return to product view
        setTimeout(() => {
            // Hide success message
            successMessage.classList.add('hidden');
            
            // Revert to Step 1 view
            document.getElementById('step-1-order').classList.remove('hidden');
            document.getElementById('step-2-mpesa').classList.add('hidden');
            
            // Return to the main product page
            hideCheckoutForm();
            
        }, 5000); // 5 seconds wait to read the success message

    } else {
        // FAILURE
        errorMessage.classList.remove('hidden');
        alert("There was an issue sending the confirmation. Please ensure your M-Pesa code is correct and try again.");
    }
    
    return false;
}


// Initialize
displayItems(items);
displayCart();
</script>


</body>
</html>